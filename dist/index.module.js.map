{"version":3,"file":"index.module.js","sources":["../src/form-builder.js","../src/index.js"],"sourcesContent":["export default class FormBuilder {\r\n  constructor(controller) {\r\n    this.controller = controller;\r\n  }\r\n\r\n  get forms() {\r\n    return this.controller.formTargets;\r\n  }\r\n\r\n  get template() {\r\n    return this.forms.slice(-1)[0];\r\n  }\r\n\r\n  get tags() {\r\n    return this.controller.constructor.tags;\r\n  }\r\n\r\n  get attributes() {\r\n    return this.controller.constructor.attributes;\r\n  }\r\n\r\n  get assocs() {\r\n    return this.controller.assocs;\r\n  }\r\n\r\n  run() {\r\n    let form = this.clone(this.template);\r\n    form.classList.remove('st-nested-form--hidden');\r\n\r\n    let newIndex = this.forms.length + this.controller.startValue;\r\n    this.renewIndex(form, newIndex);\r\n\r\n    return form;\r\n  }\r\n\r\n  clone(template) {\r\n    let clone = template.cloneNode(true);\r\n    this.clear(clone);\r\n    this.setRadio(clone);\r\n    this.removePK(clone);\r\n    return clone;\r\n  }\r\n\r\n  clear(clone) {\r\n    clone.querySelectorAll('textarea, input[type=\"text\"]').forEach(elem => elem.value = '');\r\n    clone.querySelectorAll('input[type=\"radio\"], input[type=\"checkbox\"]').forEach(elem => elem.checked = false);\r\n    clone.querySelectorAll('option').forEach(elem => elem.selected = false);\r\n    clone.querySelectorAll('input[name$=\"[_destroy]\"]').forEach(elem => elem.removeAttribute('value'));\r\n  }\r\n\r\n  setRadio(clone) {\r\n    let names = Array.from(clone.querySelectorAll('input[name][type=\"radio\"]')).map(radio => radio.name);\r\n    let nameSet = new Set(names);\r\n    nameSet.forEach(name => {\r\n      let radios = Array.from(clone.querySelectorAll(`input[type=\"radio\"][name=\"${name}\"]`));\r\n      if (radios.every(radio => radio.checked == false)) {\r\n        radios[0].checked = true;\r\n      }\r\n    });\r\n  }\r\n\r\n  removePK(form) {\r\n    let regexps = this.assocs.map(assoc => new RegExp(`${assoc.description}(\\\\])?\\\\[\\\\d+\\\\]\\\\[${assoc.pk}\\\\]$`));\r\n\r\n    form.querySelectorAll('input[name][type=\"hidden\"]').forEach(elem => {\r\n      regexps.forEach(regexp => {\r\n        if (elem.name.match(regexp)) {\r\n          elem.remove();\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  renewIndex(form, newIndex) {\r\n    let selector = this.tags.join(', ');\r\n    let regexps = this.assocs.map(assoc => new RegExp(`(${assoc.description}(\\\\[|\\\\]\\\\[|_)?)\\\\d+`));\r\n\r\n    form.querySelectorAll(selector).forEach(elem => {\r\n      this.attributes.forEach(attr => {\r\n        let value = elem.getAttribute(attr);\r\n        if (!value) return;\r\n        regexps.forEach(regexp => {\r\n          value = value.replace(regexp, '$1' + newIndex);\r\n        });\r\n        elem.setAttribute(attr, value);\r\n      });\r\n    });\r\n  }\r\n}\r\n","import { Controller } from '@hotwired/stimulus';\nimport FormBuilder from './form-builder';\nimport './index.scss';\n\nexport default class extends Controller {\n  static targets = ['form'];\n  static values = {\n    start: { type: Number, default: 0 },\n    increment: { type: Number, default: 1 },\n    max: Number,\n    addPos: { type: String, default: 'last' },\n    associations: { type: Array, default: [''] },\n    suffixes: { type: Array, default: ['_attributes'] },\n    primaryKeys: { type: Array, default: ['id'] },\n  };\n\n  static tags = ['input', 'textarea', 'select', 'label'];\n  static attributes = ['id', 'name', 'for'];\n\n  get adder() {\n    return this.element.querySelector(`[data-action=\"${this.identifier}#add\"]`);\n  }\n\n  get assocs() {\n    let associations = [].concat(this.associationsValue);\n    let suffixes = [].concat(this.suffixesValue);\n    let primaryKeys = [].concat(this.primaryKeysValue);\n    return associations.map((assoc, i) => {\n      let suffix = suffixes[i] || suffixes[0];\n      let pk = primaryKeys[i] || primaryKeys[0];\n      return { description: `${assoc}${suffix}`, pk: pk };\n    });\n  }\n\n  initialize() {\n    this.builder = new FormBuilder(this);\n  }\n\n  add(e) {\n    for (let n=0; n<this.incrementValue; n++) {\n      let form = this.builder.run();\n\n      let event = this.dispatch('before-add', { detail: { form: form }});\n      if (event.defaultPrevented) continue;\n      this.addForm(form);\n      this.dispatch('after-add', { detail: { form: form }});\n\n      if (this.hasMaxForms()) break;\n    }\n\n    e.preventDefault();\n  }\n\n  remove(e) {\n    let form = e.target.closest(`[data-${this.identifier}-target=\"form\"]`);\n    if (!form) return;\n\n    let event = this.dispatch('before-remove', { detail: { form: form }});\n    if (event.defaultPrevented) return;\n    this.removeForm(form);\n    this.dispatch('after-remove', { detail: { form: form }});\n\n    e.preventDefault();\n  }\n\n  addForm(form) {\n    if (this.addPosValue == 'first') {\n      this.formTargets[0].before(form);\n    } else {\n      this.formTargets.slice(-1)[0].after(form);\n    }\n\n    setTimeout(() => {\n      form.querySelectorAll(`[data-controller=\"${this.identifier}\"]`).forEach(nestedForm => {\n        let controller = this.application.getControllerForElementAndIdentifier(nestedForm, this.identifier);\n        if (controller) {\n          controller.formTargets.forEach(form => controller.builder.removePK(form));\n        }\n      });\n    });\n\n    this.refresh();\n  }\n\n  removeForm(form) {\n    form.classList.add('st-nested-form--hidden');\n\n    let regexps = this.assocs.map(assoc => new RegExp(`${assoc.description}(\\\\])?\\\\[\\\\d+\\\\]\\\\[_destroy\\\\]`));\n\n    form.querySelectorAll('input[name][type=hidden]').forEach(elem => {\n      regexps.forEach(regexp => {\n        if (elem.name.match(regexp)) {\n          elem.value = '1';\n        }\n      });\n    });\n\n    this.refresh();\n  }\n\n  refresh() {\n    if (this.hasMaxForms()) {\n      this.disableAdd();\n    } else {\n      this.enableAdd();\n    }\n  }\n\n  hasMaxForms() {\n    return this.maxValue &&\n           this.formTargets.filter(form => !form.matches('.st-nested-form--hidden')).length >= this.maxValue;\n  }\n\n  enableAdd() {\n    this.adder.disabled = false;\n  }\n\n  disableAdd() {\n    this.adder.disabled = true;\n  }\n}\n"],"names":["FormBuilder","constructor","controller","this","forms","formTargets","template","slice","tags","attributes","assocs","run","form","clone","classList","remove","renewIndex","length","startValue","cloneNode","clear","setRadio","removePK","querySelectorAll","forEach","elem","value","checked","selected","removeAttribute","names","Array","from","map","radio","name","Set","radios","every","regexps","assoc","RegExp","description","pk","regexp","match","newIndex","selector","join","attr","getAttribute","replace","setAttribute","Controller","adder","element","querySelector","identifier","associations","concat","associationsValue","suffixes","suffixesValue","primaryKeys","primaryKeysValue","i","initialize","builder","add","e","n","incrementValue","dispatch","detail","defaultPrevented","addForm","hasMaxForms","preventDefault","target","closest","removeForm","addPosValue","before","after","setTimeout","nestedForm","application","getControllerForElementAndIdentifier","refresh","disableAdd","enableAdd","maxValue","filter","matches","disabled","targets","values","start","type","Number","default","increment","max","addPos","String"],"mappings":"sDAAqBA,EACnBC,YAAYC,GACVC,KAAKD,WAAaA,EAGhBE,YACF,YAAYF,WAAWG,YAGrBC,eACF,YAAYF,MAAMG,OAAO,GAAG,GAG1BC,WACF,YAAYN,WAAWD,YAAYO,KAGjCC,iBACF,YAAYP,WAAWD,YAAYQ,WAGjCC,aACF,YAAYR,WAAWQ,OAGzBC,MACE,IAAIC,EAAOT,KAAKU,MAAMV,KAAKG,UAM3B,OALAM,EAAKE,UAAUC,OAAO,0BAGtBZ,KAAKa,WAAWJ,EADDT,KAAKC,MAAMa,OAASd,KAAKD,WAAWgB,YAG5CN,EAGTC,MAAMP,GACJ,IAAIO,EAAQP,EAASa,WAAU,GAI/B,OAHAhB,KAAKiB,MAAMP,GACXV,KAAKkB,SAASR,GACdV,KAAKmB,SAAST,GACPA,EAGTO,MAAMP,GACJA,EAAMU,iBAAiB,gCAAgCC,QAAQC,GAAQA,EAAKC,MAAQ,IACpFb,EAAMU,iBAAiB,+CAA+CC,QAAQC,GAAQA,EAAKE,SAAU,GACrGd,EAAMU,iBAAiB,UAAUC,QAAQC,GAAQA,EAAKG,UAAW,GACjEf,EAAMU,iBAAiB,6BAA6BC,QAAQC,GAAQA,EAAKI,gBAAgB,UAG3FR,SAASR,GACP,IAAIiB,EAAQC,MAAMC,KAAKnB,EAAMU,iBAAiB,8BAA8BU,IAAIC,GAASA,EAAMC,MACjF,IAAIC,IAAIN,GACdN,QAAQW,IACd,IAAIE,EAASN,MAAMC,KAAKnB,EAAMU,8CAA8CY,SACxEE,EAAOC,MAAMJ,GAA0B,GAAjBA,EAAMP,WAC9BU,EAAO,GAAGV,SAAU,KAK1BL,SAASV,GACP,IAAI2B,EAAUpC,KAAKO,OAAOuB,IAAIO,GAAS,IAAIC,OAAUD,EAAME,kCAAiCF,EAAMG,YAElG/B,EAAKW,iBAAiB,8BAA8BC,QAAQC,IAC1Dc,EAAQf,QAAQoB,IACVnB,EAAKU,KAAKU,MAAMD,IAClBnB,EAAKV,aAMbC,WAAWJ,EAAMkC,GACf,IAAIC,EAAW5C,KAAKK,KAAKwC,KAAK,MAC1BT,EAAUpC,KAAKO,OAAOuB,IAAIO,GAAS,IAAIC,WAAWD,EAAME,qCAE5D9B,EAAKW,iBAAiBwB,GAAUvB,QAAQC,IACtCtB,KAAKM,WAAWe,QAAQyB,IACtB,IAAIvB,EAAQD,EAAKyB,aAAaD,GACzBvB,IACLa,EAAQf,QAAQoB,IACdlB,EAAQA,EAAMyB,QAAQP,EAAQ,KAAOE,KAEvCrB,EAAK2B,aAAaH,EAAMvB,yBChFH2B,EAevBC,YACF,YAAYC,QAAQC,+BAA+BrD,KAAKsD,qBAGtD/C,aACF,IAAIgD,EAAe,GAAGC,OAAOxD,KAAKyD,mBAC9BC,EAAW,GAAGF,OAAOxD,KAAK2D,eAC1BC,EAAc,GAAGJ,OAAOxD,KAAK6D,kBACjC,OAAON,EAAazB,IAAI,CAACO,EAAOyB,KAGvB,CAAEvB,eAAgBF,GAFZqB,EAASI,IAAMJ,EAAS,IAEMlB,GADlCoB,EAAYE,IAAMF,EAAY,MAK3CG,aACE/D,KAAKgE,QAAU,IAAInE,EAAYG,MAGjCiE,IAAIC,GACF,IAAK,IAAIC,EAAE,EAAGA,EAAEnE,KAAKoE,eAAgBD,IAAK,CACxC,IAAI1D,EAAOT,KAAKgE,QAAQxD,MAGxB,IADYR,KAAKqE,SAAS,aAAc,CAAEC,OAAQ,CAAE7D,KAAMA,KAChD8D,mBACVvE,KAAKwE,QAAQ/D,GACbT,KAAKqE,SAAS,YAAa,CAAEC,OAAQ,CAAE7D,KAAMA,KAEzCT,KAAKyE,eAAe,MAG1BP,EAAEQ,iBAGJ9D,OAAOsD,GACL,IAAIzD,EAAOyD,EAAES,OAAOC,iBAAiB5E,KAAKsD,8BACrC7C,IAEOT,KAAKqE,SAAS,gBAAiB,CAAEC,OAAQ,CAAE7D,KAAMA,KACnD8D,mBACVvE,KAAK6E,WAAWpE,GAChBT,KAAKqE,SAAS,eAAgB,CAAEC,OAAQ,CAAE7D,KAAMA,KAEhDyD,EAAEQ,mBAGJF,QAAQ/D,GACkB,SAApBT,KAAK8E,YACP9E,KAAKE,YAAY,GAAG6E,OAAOtE,GAE3BT,KAAKE,YAAYE,OAAO,GAAG,GAAG4E,MAAMvE,GAGtCwE,WAAW,KACTxE,EAAKW,sCAAsCpB,KAAKsD,iBAAgBjC,QAAQ6D,IACtE,IAAInF,EAAaC,KAAKmF,YAAYC,qCAAqCF,EAAYlF,KAAKsD,YACpFvD,GACFA,EAAWG,YAAYmB,QAAQZ,GAAQV,EAAWiE,QAAQ7C,SAASV,QAKzET,KAAKqF,UAGPR,WAAWpE,GACTA,EAAKE,UAAUsD,IAAI,0BAEnB,IAAI7B,EAAUpC,KAAKO,OAAOuB,IAAIO,GAAS,IAAIC,OAAUD,EAAME,+CAE3D9B,EAAKW,iBAAiB,4BAA4BC,QAAQC,IACxDc,EAAQf,QAAQoB,IACVnB,EAAKU,KAAKU,MAAMD,KAClBnB,EAAKC,MAAQ,SAKnBvB,KAAKqF,UAGPA,UACMrF,KAAKyE,cACPzE,KAAKsF,aAELtF,KAAKuF,YAITd,cACE,YAAYe,UACLxF,KAAKE,YAAYuF,OAAOhF,IAASA,EAAKiF,QAAQ,4BAA4B5E,QAAUd,KAAKwF,SAGlGD,YACEvF,KAAKmD,MAAMwC,UAAW,EAGxBL,aACEtF,KAAKmD,MAAMwC,UAAW,KAjHjBC,QAAU,CAAC,UACXC,OAAS,CACdC,MAAO,CAAEC,KAAMC,OAAQC,QAAS,GAChCC,UAAW,CAAEH,KAAMC,OAAQC,QAAS,GACpCE,IAAKH,OACLI,OAAQ,CAAEL,KAAMM,OAAQJ,QAAS,QACjC1C,aAAc,CAAEwC,KAAMnE,MAAOqE,QAAS,CAAC,KACvCvC,SAAU,CAAEqC,KAAMnE,MAAOqE,QAAS,CAAC,gBACnCrC,YAAa,CAAEmC,KAAMnE,MAAOqE,QAAS,CAAC,UAGjC5F,KAAO,CAAC,QAAS,WAAY,SAAU,WACvCC,WAAa,CAAC,KAAM,OAAQ"}