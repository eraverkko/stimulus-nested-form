{"version":3,"file":"index.umd.js","sources":["../src/form-builder.js","../src/index.js"],"sourcesContent":["export default class FormBuilder {\n  constructor(controller) {\n    this.controller = controller;\n  }\n\n  get forms() {\n    return this.controller.formTargets;\n  }\n\n  get template() {\n    return this.forms.slice(-1)[0];\n  }\n\n  get tags() {\n    return this.controller.constructor.tags;\n  }\n\n  get attributes() {\n    return this.controller.constructor.attributes;\n  }\n\n  get assocs() {\n    return this.controller.assocs;\n  }\n\n  run() {\n    let form = this.clone(this.template);\n    form.style.display = '';\n\n    let newIndex = this.forms.length + this.controller.startValue;\n    this.renewIndex(form, newIndex);\n\n    return form;\n  }\n\n  clone(template) {\n    let clone = template.cloneNode(true);\n    this.clear(clone);\n    this.setRadio(clone);\n    this.removePK(clone);\n    return clone;\n  }\n\n  clear(clone) {\n    clone.querySelectorAll('textarea, input[type=text]').forEach(elem => elem.value = '');\n    clone.querySelectorAll('input[type=radio], input[type=checkbox]').forEach(elem => elem.checked = false);\n    clone.querySelectorAll('option').forEach(elem => elem.selected = false);\n    clone.querySelectorAll('input[name$=\"[_destroy]\"]').forEach(elem => elem.removeAttribute('value'));\n  }\n\n  setRadio(clone) {\n    let names = Array.from(clone.querySelectorAll('input[name][type=radio]')).map(radio => radio.name);\n    let nameSet = new Set(names);\n    nameSet.forEach(name => {\n      let radios = Array.from(clone.querySelectorAll(`input[type=radio][name=\"${name}\"]`));\n      if (radios.every(radio => radio.checked == false)) {\n        radios[0].checked = true;\n      }\n    });\n  }\n\n  removePK(form) {\n    let regexps = this.assocs.map(assoc => new RegExp(`${assoc.description}(\\\\])?\\\\[\\\\d+\\\\]\\\\[${assoc.pk}\\\\]$`));\n\n    form.querySelectorAll('input[name][type=hidden]').forEach(elem => {\n      regexps.forEach(regexp => {\n        if (elem.name.match(regexp)) {\n          elem.remove();\n        }\n      });\n    });\n  }\n\n  renewIndex(form, newIndex) {\n    let selector = this.tags.join(', ');\n    let regexps = this.assocs.map(assoc => new RegExp(`(${assoc.description}(\\\\[|\\\\]\\\\[|_)?)\\\\d+`));\n\n    form.querySelectorAll(selector).forEach(elem => {\n      this.attributes.forEach(attr => {\n        let value = elem.getAttribute(attr);\n        if (!value) return;\n        regexps.forEach(regexp => {\n          value = value.replace(regexp, '$1' + newIndex);\n        });\n        elem.setAttribute(attr, value);\n      });\n    });\n  }\n}\n","import { Controller } from '@hotwired/stimulus';\nimport FormBuilder from './form-builder';\n\nexport default class extends Controller {\n  static targets = ['form'];\n  static values = {\n    start: { type: Number, default: 0 },\n    increment: { type: Number, default: 1 },\n    max: Number,\n    addPos: { type: String, default: 'last' },\n    associations: { type: Array, default: [''] },\n    suffixes: { type: Array, default: ['_attributes'] },\n    primaryKeys: { type: Array, default: ['id'] },\n  };\n\n  static tags = ['input', 'textarea', 'select', 'label'];\n  static attributes = ['id', 'name', 'for'];\n\n  get adder() {\n    return this.scope.findElement(`[data-action=\"${this.identifier}#add\"]`);\n  }\n\n  get assocs() {\n    let associations = [].concat(this.associationsValue);\n    let suffixes = [].concat(this.suffixesValue);\n    let primaryKeys = [].concat(this.primaryKeysValue);\n    return associations.map((assoc, i) => {\n      let suffix = suffixes[i] || suffixes[0];\n      let pk = primaryKeys[i] || primaryKeys[0];\n      return { description: `${assoc}${suffix}`, pk: pk };\n    });\n  }\n\n  initialize() {\n    this.builder = new FormBuilder(this);\n  }\n\n  add(e) {\n    for (let n=0; n<this.incrementValue; n++) {\n      let form = this.builder.run();\n\n      let event = this.dispatch('before-add', { detail: { form: form }});\n      if (event.defaultPrevented) continue;\n      this.addForm(form);\n      this.dispatch('after-add', { detail: { form: form }});\n\n      if (this.hasMaxForms()) break;\n    }\n\n    e.preventDefault();\n  }\n\n  remove(e) {\n    let form = e.target.closest(`[data-${this.identifier}-target=\"form\"]`);\n    if (!form) return;\n\n    let event = this.dispatch('before-remove', { detail: { form: form }});\n    if (event.defaultPrevented) return;\n    this.removeForm(form);\n    this.dispatch('after-remove', { detail: { form: form }});\n\n    e.preventDefault();\n  }\n\n  addForm(form) {\n    if (this.addPosValue == 'first') {\n      this.formTargets[0].before(form);\n    } else {\n      this.formTargets.slice(-1)[0].after(form);\n    }\n\n    setTimeout(() => {\n      form.querySelectorAll(`[data-controller=\"${this.identifier}\"]`).forEach(nestedForm => {\n        let controller = this.application.getControllerForElementAndIdentifier(nestedForm, this.identifier);\n        if (controller) {\n          controller.formTargets.forEach(form => controller.builder.removePK(form));\n        }\n      });\n    });\n\n    this.refresh();\n  }\n\n  removeForm(form) {\n    form.style.display = 'none';\n\n    let regexps = this.assocs.map(assoc => new RegExp(`${assoc.description}(\\\\])?\\\\[\\\\d+\\\\]\\\\[_destroy\\\\]`));\n\n    form.querySelectorAll('input[name][type=hidden]').forEach(elem => {\n      regexps.forEach(regexp => {\n        if (elem.name.match(regexp)) {\n          elem.value = '1';\n        }\n      });\n    });\n\n    this.refresh();\n  }\n\n  refresh() {\n    if (this.hasMaxForms()) {\n      this.toggleAdder(false);\n    } else {\n      this.toggleAdder(true);\n    }\n  }\n\n  hasMaxForms() {\n    return this.maxValue &&\n           this.formTargets.filter(form => form.style.display != 'none').length >= this.maxValue;\n  }\n\n  toggleAdder(enabled) {\n    if (this.adder) this.adder.disabled = !enabled;\n  }\n}\n"],"names":["FormBuilder","controller","this","_proto","prototype","run","form","clone","template","style","display","renewIndex","forms","length","startValue","cloneNode","clear","setRadio","removePK","querySelectorAll","forEach","elem","value","checked","selected","removeAttribute","names","Array","from","map","radio","name","Set","radios","every","regexps","assocs","assoc","RegExp","description","pk","regexp","match","remove","newIndex","_this","selector","tags","join","attributes","attr","getAttribute","replace","setAttribute","_createClass","key","get","formTargets","slice","constructor","_default","_Controller","apply","arguments","initialize","builder","add","e","n","incrementValue","dispatch","detail","defaultPrevented","addForm","hasMaxForms","preventDefault","target","closest","identifier","removeForm","addPosValue","before","after","setTimeout","nestedForm","application","getControllerForElementAndIdentifier","refresh","toggleAdder","maxValue","filter","enabled","adder","disabled","scope","findElement","associations","concat","associationsValue","suffixes","suffixesValue","primaryKeys","primaryKeysValue","i","Controller","targets","values","start","type","Number","default","increment","max","addPos","String"],"mappings":"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"}